name: CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20.x"

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for better caching

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ” Run ESLint
        run: npm run lint

      - name: ðŸ“ Run TypeScript check
        run: npm run type-check

      - name: ðŸ’… Check code formatting
        run: npm run format:check

      - name: ðŸ”’ Security audit
        run: npm run security:check
        continue-on-error: true

      - name: ðŸ›¡ï¸ Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml
          no-git: false
          verbose: true
          redact: true
        continue-on-error: true

  build:
    name: Build Project
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ðŸ“¦ Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: ðŸ“¦ Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-

      - name: ðŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: ðŸ—ï¸ Build project
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: ðŸ“Š Build size analysis
        run: |
          if [ -d "out" ]; then
            echo "### ðŸ“¦ Build Size" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            du -sh out/ >> $GITHUB_STEP_SUMMARY
            find out/ -type f | wc -l | xargs echo "Total files:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ github.sha }}
          path: out/
          retention-days: 7
          compression-level: 9
          if-no-files-found: error

  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build-${{ github.sha }}
          path: out/
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸš€ Deploy to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: "--prod"
          working-directory: ./
        continue-on-error: true

  summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [quality, build, deploy]
    if: always()
    timeout-minutes: 2

    steps:
      - name: ðŸ“Š Create summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.quality.result }}" == "success" ]; then
            echo "| Quality Checks | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.quality.result }}" == "failure" ]; then
            echo "| Quality Checks | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Quality Checks | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "| Build | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" == "failure" ]; then
            echo "| Build | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            if [ "${{ needs.deploy.result }}" == "success" ]; then
              echo "| Deployment | âœ… Deployed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy.result }}" == "failure" ]; then
              echo "| Deployment | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy.result }}" == "skipped" ]; then
              echo "| Deployment | â­ï¸ Skipped (Build failed) |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Deployment | âš ï¸ Cancelled |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Deployment | â­ï¸ Skipped (Not main branch) |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

          # Determine overall status
          if [ "${{ needs.quality.result }}" == "failure" ] || [ "${{ needs.build.result }}" == "failure" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Pipeline failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            if [ "${{ needs.deploy.result }}" == "failure" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸ **Pipeline completed with deployment failure**" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy.result }}" == "success" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Pipeline succeeded**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Pipeline succeeded**" >> $GITHUB_STEP_SUMMARY
          fi
